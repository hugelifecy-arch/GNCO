import { execSync } from 'node:child_process';
import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..', '..');
const appRoot = path.resolve(__dirname, '..');
const truthPath = path.join(repoRoot, 'truth', 'gnco.truth.json');
const publicDir = path.join(appRoot, 'public');

const requiredKeys = [
  'projectName',
  'status',
  'whatItIs',
  'whatItIsNot',
  'featuresNow',
  'featuresPlanned',
  'riskDisclosureBullets',
  'lastUpdated',
  'version'
];

const escapeHtml = (value) => String(value)
  .replaceAll('&', '&amp;')
  .replaceAll('<', '&lt;')
  .replaceAll('>', '&gt;')
  .replaceAll('"', '&quot;')
  .replaceAll("'", '&#39;');

const assertTruthy = (condition, message) => {
  if (!condition) {
    throw new Error(message);
  }
};

const truth = JSON.parse(fs.readFileSync(truthPath, 'utf8'));
for (const key of requiredKeys) {
  assertTruthy(key in truth, `Missing required truth key: ${key}`);
}
assertTruthy(['Prototype', 'Beta', 'Live'].includes(truth.status), 'status must be Prototype, Beta, or Live');

let gitSha = truth.version;
try {
  gitSha = execSync('git rev-parse --short HEAD', { cwd: repoRoot, stdio: ['ignore', 'pipe', 'ignore'] }).toString().trim();
} catch {
  // Keep fallback version from truth source file.
}

const buildDate = new Date().toISOString().slice(0, 10);

const list = (items) => items.map((item) => `      <li>${escapeHtml(item)}</li>`).join('\n');

const investorHtml = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GNCO Investor Overview</title>
  </head>
  <body>
    <main>
      <h1>${escapeHtml(truth.projectName)} - Investor Overview</h1>
      <p>This page is a static, crawlable compliance summary generated from <code>truth/gnco.truth.json</code>.</p>

      <h2>Project overview</h2>
      <p>${escapeHtml(truth.whatItIs)}</p>

      <h2>Current status</h2>
      <p><strong>Status:</strong> ${escapeHtml(truth.status)}</p>

      <h2>What this software does not do</h2>
      <ul>
${list(truth.whatItIsNot)}
      </ul>
      <p><strong>Compliance statement:</strong> No guaranteed returns, no APY, and not investment advice.</p>

      <h2>Features available now</h2>
      <ul>
${list(truth.featuresNow)}
      </ul>

      <h2>Features planned / under research</h2>
      <ul>
${list(truth.featuresPlanned)}
      </ul>

      <h2>Risk disclosures</h2>
      <ul>
${list(truth.riskDisclosureBullets)}
      </ul>

      <h2>Forward-looking statements</h2>
      <p>Statements about planned capabilities, roadmap items, research, or future outcomes are forward-looking and inherently uncertain. Actual results may differ materially.</p>

      <h2>No offer / no solicitation</h2>
      <p>This website content is for informational purposes only and does not constitute an offer to sell, a solicitation of an offer to buy, or a recommendation regarding any security, instrument, or investment strategy.</p>

      <h2>Document metadata</h2>
      <p><strong>Source last updated:</strong> ${escapeHtml(truth.lastUpdated)}</p>
      <p><strong>Build date:</strong> ${escapeHtml(buildDate)}</p>
      <p><strong>Version:</strong> ${escapeHtml(gitSha)}</p>

      <p><a href="./disclosures.html">Read full disclosures</a></p>
    </main>
  </body>
</html>
`;

const disclosuresHtml = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GNCO Disclosures</title>
  </head>
  <body>
    <main>
      <h1>${escapeHtml(truth.projectName)} - Disclosures</h1>
      <p>This page is generated from the canonical Source of Truth at <code>truth/gnco.truth.json</code>.</p>

      <h2>Not an offer; not investment advice</h2>
      <p>Nothing on this site constitutes an offer, invitation, recommendation, or solicitation to buy or sell securities or any other financial product. Content is general information only and is not legal, tax, accounting, or investment advice.</p>

      <h2>Forward-looking statements</h2>
      <p>Any statement regarding future functionality, release timing, integration plans, operational readiness, market opportunity, or expected outcomes is forward-looking and subject to material uncertainty.</p>

      <h2>Technology and methodology limitations</h2>
      <ul>
${list(truth.riskDisclosureBullets)}
      </ul>
      <p>Interactive outputs are generated by software logic and assumptions that may be incomplete, stale, or incorrect. Independent expert review is required before reliance.</p>

      <h2>Jurisdiction notice</h2>
      <p>Availability and interpretation of this information may differ across jurisdictions. Users are responsible for complying with all applicable local laws and regulations.</p>

      <h2>Status and scope</h2>
      <p><strong>Status:</strong> ${escapeHtml(truth.status)}</p>
      <p><strong>Scope today:</strong> ${escapeHtml(truth.whatItIs)}</p>
      <p><strong>Out of scope:</strong> This is not an investment product and does not provide guaranteed returns.</p>

      <h2>Document metadata</h2>
      <p><strong>Source last updated:</strong> ${escapeHtml(truth.lastUpdated)}</p>
      <p><strong>Build date:</strong> ${escapeHtml(buildDate)}</p>
      <p><strong>Version:</strong> ${escapeHtml(gitSha)}</p>

      <p><a href="./investor.html">Back to investor overview</a></p>
    </main>
  </body>
</html>
`;

fs.mkdirSync(publicDir, { recursive: true });
fs.writeFileSync(path.join(publicDir, 'investor.html'), investorHtml);
fs.writeFileSync(path.join(publicDir, 'disclosures.html'), disclosuresHtml);

process.stdout.write('Generated public/investor.html and public/disclosures.html\n');
